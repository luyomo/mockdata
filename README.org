#+OPTIONS: \n:t
* Background
  [[https://www.mockaroo.com/][mockaroo]] is one commerial tool for mock data generation. And I tried to use it even though it's one commerial one. But finally I gave it up because I need to big data import. Also found there is another open source [[https://generatedata.com/][generatedata]] which also generated data for you. The reason I did not decide to use it is that I need one API not GUI. My idea is that I generate the data and import to TiDB directly with tidb lightning.
* Install
  #+BEGIN_SRC
OhMyTiUP$ wget https://github.com/luyomo/mockdata/releases/download/v0.0.6/mockdata_0.0.6_linux_amd64.tar.gz
OhMyTiUP$ tar xvf mockdata_0.0.6_linux_amd64.tar.gz
OhMyTiUP$ mv bin/* /usr/local/bin/
  #+END_SRC
* Support function
 + ID
   ID sequence, primary key.
 + String template
   String from template
 + uuid
 + Data from string list
 + Random int
 + Random date
 + Random string
 + Json data
   The json is generated from the template in which defined function generate the data for json. The idea is from [[https://json-generator.com/][json generate]]. Will continue to add more and more functions.
* DDL
  #+BEGIN_SRC
 CREATE TABLE `test01` (
   `id` bigint(20) NOT NULL,
   `payer` varchar(64) DEFAULT NULL,
   `receiver` varchar(64) DEFAULT NULL,
   `amount` bigint(20) DEFAULT NULL,
   `payment_uuid` varchar(64) DEFAULT NULL,
   `payment_type` varchar(32) DEFAULT NULL,
   `payment_date` date DEFAULT NULL,
   `user_id` varchar(32) DEFAULT NULL,
   `access_content` json DEFAULT NULL,
   PRIMARY KEY (`id`) /*T![clustered_index] CLUSTERED */
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;
  #+END_SRC
* Data config file
#+BEGIN_SRC
ROWS: 5000
COLUMNS:
  - 
    IDX: 01
    Name: id
    DataType: int
    Function: sequence
  -
    IDX: 02
    Name: payer
    DataType: string
    Function: template
    Parameters:
      - key: text
        value: User{{.Label}}
  -
    IDX: 03
    Name: receiver
    DataType: string
    Function: template
    Parameters:
      - key: name
        value: RandomUserID
      - key: format
        value: "user%010d"
      - key: content
        value: "TestData{{.GenerateData}}"
      - key: min
        value: 1
      - key: max
        value: 1000
  -
    IDX: 04
    Name: amount
    DataType: int
    Function: random
    Max: 10000
    Min: 1
  - IDX: 05
    Name: payment_uuid
    DataType: string
    Function: uuid
  - IDX: 06
    Name: payment_type
    DataType: string
    Function: list
    Values:
    - international
    - national
    - others
  - IDX: 07
    Name: payment_date
    DataType: Date
    Function: RandomDate
    Parameters:
      - key: min
        value: 2022-01-01
      - key: max
        value: 2022-06-01
   - IDX: 08
     Name: user_id
     DataType: string
     Function: RandomString
     Parameters:
       - key: min
         value: 6
       - key: max
         value: 8
   - IDX: 09
     Name: access_content
     DataType: json
     Function: Template
     Parameters:
       - key: content
         value: '{"access_type": "{{$BROWSER}}", "ip_address": "{{$IPADDR}}"}'
#+END_SRC
** sequence
To generate sequential integers using the sequence function in this tool, you can configure your data schema as follows:
#+BEGIN_SRC
- IDX: 01
  Name: id
  DataType: int
  Function: sequence
#+END_SRC
Explanation:
- Function: sequence generates a sequence of integers, starting from a specified initial value and incrementing by a specified step.
** RandomString
To generate random strings using the RandomString function in this tool, you can configure your data schema as follows:
#+BEGIN_SRC
- IDX: 03
  Name: name
  DataType: string
  Function: RandomString
  Parameters:
  - key: min
    value: 20
  - key: max
    value: 30
#+END_SRC
Explanation:
- Function: RandomString generates a random string with a specified length range.
- Parameters:
  + min: The minimum length of the generated string (inclusive).
  + max: The maximum length of the generated string (inclusive).
** RandomDate
To generate random dates using the RandomDate function in this tool, you can configure your data schema as follows:
#+BEGIN_SRC
- IDX: 06
  Name: updated_at
  DataType: datetime
  Function: RandomDate
  Parameters:
  - key: min
    value: 2023-01-01
  - key: max
    value: 2023-12-31
  - key: after
    value: created_at
  - key: minDays
    value: 0
  - key: maxDays
    value: 7
#+END_SRC
Explanation:  
- Function: RandomDate generates a random date within a specified range.
- Parameters:
  + min: The earliest possible date in the range (inclusive). This should be a string in the format "YYYY-MM-DD".
  + max: The latest possible date in the range (inclusive). This should be a string in the format "YYYY-MM-DD".
  + after: The name of another field (e.g., created_at) that this date should be after. This ensures that the generated date is logically consistent with another date field.
  + minDays: The minimum number of days after the after date.
  + maxDays: The maximum number of days after the after date.
Usage:  
- The RandomDate function generates a random date that is between minDays and maxDays after the date specified in the after field.
- If the after field is not specified, it generates a random date between min and max dates.
- This function is useful for creating realistic date ranges, such as ensuring that an updated_at date is always after a created_at date.
- The min and max parameters define the absolute range within which the random date can fall, while minDays and maxDays define the relative range after the after date.
** RandomDecimal
Generates a random decimal number within a specified range.
#+BEGIN_SRC
- IDX: 04
  Name: price
  DataType: decimal
  Function: RandomDecimal
#+END_SRC
Function Description:  
- Generates a decimal number in format: integer.fraction
- Integer part range: 0-99
- Fractional part range: 00-99 (fixed two decimal places)
- Example output: "45.78", "3.15"
** WeightedIntRange
To generate random integers within weighted ranges using the WeightedIntRange function in this tool, you can configure your data schema as follows:
#+BEGIN_SRC
- IDX: 07
  Name: age
  DataType: integer
  Function: WeightedIntRange
  Parameters:
  - key: values
    value:
      - "1-10"
      - "11-20"
      - "21-30"
  - key: weights
    value:
      - 1
      - 2
      - 3
#+END_SRC
Explanation:  
- Function: WeightedIntRange generates a random integer within specified ranges, with each range having a different weight.
- Parameters:
  + values: A list of string ranges, where each range is in the format "min-max". For example, "1-10" represents integers from 1 to 10 (inclusive).
  + weights: A list of integers representing the weights for each corresponding range in values. Higher weights increase the likelihood of selecting a number from that range.
Usage:  
- The WeightedIntRange function generates a random integer within specified ranges, with each range having a different weight.  
- The values parameter defines the ranges, and the weights parameter defines the likelihood of selecting a number from each range.
- For example, if values is ["1-10", "11-20", "21-30"] and weights is [1, 2, 3], the function is more likely to generate a number from the range "21-30" compared to "1-10".
- This function is useful for generating realistic data where certain ranges are more common than others.
** WeightedList
To generate random values from a weighted list using the WeightedList function in this tool, you can configure your data schema as follows:
#+BEGIN_SRC
- IDX: 07
  Name: storage_for
  DataType: string
  Function: WeightedList
  Parameters:
  - key: values
    value: ["BTC", "ETH", "XRP", "JPY", "USD", "EUR", null]
  - key: weights
    value: [30, 25, 15, 10, 10, 5, 5]
#+END_SRC
Explanation:  
- Function: WeightedList generates a random value from a list, with each value having a different weight.
- Parameters:
  + values: A list of values that can be of any type (strings, numbers, null, etc.). These are the possible values that can be generated.
  + weights: A list of integers representing the weights for each corresponding value in values. Higher weights increase the likelihood of selecting that value.
Usage:
- The WeightedList function generates a random value from a list, with each value having a different weight.
- The values parameter defines the possible values that can be generated.
- The weights parameter defines the likelihood of selecting each value.
- For example, if values is ["BTC", "ETH", "XRP", "JPY", "USD", "EUR", null] and weights is [30, 25, 15, 10, 10, 5, 5], the function is more likely to generate "BTC" compared to "EUR".
- This function is useful for generating realistic data where certain values are more common than others.
** BROWSER
Randomly selects a browser name from a predefined list.
#+BEGIN_SRC
- IDX: 01
  Name: browser_name
  DataType: varchar
  Function: BROWSER
#+END_SRC
Function Description:  
- Randomly selects from the fixed browser list: ["Chrome", "IE", "Safari"]
- Returns a string value
- Suitable for simulating user agent data or browser usage statistics
** IPADDR
Generates a random IPv4 address.
#+BEGIN_SRC
- IDX: 02
  Name: ip_address
  DataType: varchar
  Function: IPADDR
#+END_SRC
Function Description:  
- Generates an IPv4 address in the format: X.X.X.X
- First octet range: 1-254 (avoids 0)
- Remaining octets range: 0-255
- Example output: "192.168.1.100"
** UUID
Generates a version 4 UUID (Universally Unique Identifier).
#+BEGIN_SRC
- IDX: 03
  Name: user_uuid
  DataType: varchar
  Function: UUID
#+END_SRC
Function Description:  
- Uses github.com/google/uuid library to generate UUID version 4
- Format: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
- Guarantees uniqueness within a single generation (extremely low collision probability)
- Suitable for scenarios requiring globally unique identifiers
** UniqueRandomString
Generates a random string with guaranteed uniqueness by appending a sequential identifier.
#+BEGIN_SRC
- IDX: 06
  Name: unique_code
  DataType: varchar
  Function: UniqueRandomString
  Parameters:
    - key: min
      value: "5"
    - key: max
      value: "10"
#+END_SRC
Function Description:  
- Random String Generation:
  + Generates a random string with length between min and max (inclusive)
  + Characters are randomly selected from the uppercase and lowercase alphabet (A-Z, a-z)
  + Example: For min=5, max=10, might generate "kLmNoP" (6 characters)
- Uniqueness Guarantee:
  + Appends a unique integer suffix to the random string
  + The suffix is calculated as: (threads Ã— rows) + current_row_index
  + This ensures every generated string is globally unique within the data generation session
  + Example: "kLmNoP12345"
Parameters:
- min (string, required): Minimum length of the random string portion
- max (string, required): Maximum length of the random string portion

* Command
  | Parameter | Comment                                        |
  |-----------+------------------------------------------------|
  | config    | The data config file to generate the data      |
  | output    | The file to be outputed to                     |
  | rows      | Number of rows to be generated for each thread |
  | threads   | Number of threads                              |

  [[./png/001.png]]
  [[./png/002.png]]

* Example
** Run the mockdata command to import data into TiDB
  #+BEGIN_SRC
  $ mockdata --threads 1 --loop 1 --config /tmp/config.yaml --output /tmp/mockdata --file-name=test.test01 --rows 20 --host 10.0.154.155 --user=root --pd-ip=10.0.240.79 ----lightning-ver v8.5.4
  #+END_SRC
  [[./png/003.png]]
** Check the result
 [[./png/004.png]]
* Performance
  | Secnario                 | Data volume | Disk Size | Execution Time(s) | rows/s | Volumes/s |
  |--------------------------+-------------+-----------+-------------------+--------+-----------|
  | First test. Sinle thread |     5000000 | 223M      |               129 |  38800 | 1.7MB     |
  | parallel: 2              |    10000000 | 446M      |               140 |  77600 | 3.4MB     |
  | parallel: 10             |    50000000 | 2.3G      |               240 | 208000 | 9.8MB     |
  | parallel: 16             |    80000000 | 3.5G      |               433 | 184757 | 8.2MB     |
** Run the mockdata command to generate the data only
  #+BEGIN_SRC
  $ mockdata --threads 1 --loop 1 --config /tmp/config.yaml --output /tmp/mockdata --file-name=test.test01 --rows 20 --data-only
  #+END_SRC

* Reference
** Issues
   + missing go.sum entry for module providing package
#+BEGIN_SRC
go mod tidy
#+END_SRC

* Performance test
#+BEGIN_SRC
OhMyTiUP$ ./bin/mockdata --threads 16 --loop 1 --config etc/data.config.yaml --output /tmp/mockdata --file-name=test.test01 --rows 20  --host=172.83.1.89 --user=root --pd-ip=172.83.1.241 --lightning-ver v8.0.0
#+END_SRC
** c5d.4xlarge
  | Number of rows | Execution time | Transaction | Threads | Size |
  |----------------+----------------+-------------+---------+------|
  | 160 millions   |             29 |      100000 |      16 | 14G  |
  | 160 millions   |             23 |      100000 |      32 | 14G  |
  | 160 millions   |             21 |      200000 |      32 | 14G  |

** c5a.8xlarge
  | Number of rows | Execution time | Transaction | Threads | Size |
  |----------------+----------------+-------------+---------+------|
  | 300 millions   |             27 |      200000 |      64 | 26G  |
  | 610 millions   |             50 |      400000 |      64 | 53G  |

* TODO
 + Convert the data generation to distribution system to fasten the performance.
 + Generate data to ttl directly for tikv-importer to improve the performance.
 + Generate CSV file to S3
 + Add the TUI from OhMyTiUP To mockdata

* event_month
  #+BEGIN_SRC
    time ./bin/mockdata --loop 100 --config etc/event_month.yaml --output /tmp/mockdata --file-name=test.event_month --rows 100000  --host=182.83.1.171 --user=root --pd-ip=182.83.1.118
    real    144m8.529s
    user    380m38.129s
    sys     35m37.681s

    MySQL [test]> select data_length/(1024*1024*1024) from information_schema.tables where table_name = 'event_month' \G
    data_length/(1024*1024*1024): 176.0461
    1 row in set (0.008 sec)
    
    MySQL [information_schema]> select * from table_storage_stats where table_schema = 'test' and table_name = 'event_month';
    +--------------+-------------+----------+------------+--------------+--------------------+------------+------------+
    | TABLE_SCHEMA | TABLE_NAME  | TABLE_ID | PEER_COUNT | REGION_COUNT | EMPTY_REGION_COUNT | TABLE_SIZE | TABLE_KEYS |
    +--------------+-------------+----------+------------+--------------+--------------------+------------+------------+
    | test         | event_month |      126 |          3 |         2128 |                 79 |     201236 |  160053659 |
    +--------------+-------------+----------+------------+--------------+--------------------+------------+------------+
    1 row in set (0.005 sec)
    
    admin@ip-182-83-1-7:~/tidb/tidb-data$ du -sh tikv-20160/
    24G     tikv-20160/
    admin@ip-182-83-1-7:~/tidb/tidb-data/tikv-20160$ du -sh * 
    0       LOCK
    23G     db
    1.2M    import
    20K     last_tikv.toml
    23M     raft-engine
    0       raftdb.info
    54M     rocksdb.info
    4.0K    snap
    1.1G    space_placeholder_file

    | Disk Size   | Table Size | Compress ratio |
    |-------------+------------+----------------|
    | 23GB*3=69GB | 170GB      | 1:8            |
  #+END_SRC

