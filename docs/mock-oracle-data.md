# Background
I got a request to migrate more than 500 DDL from oracle to TiDB database, which is broken down into below three small tasks:
  * DDL conversion from oracle to TiDB
  * Test data generation into oracle
  * Data migration verification from oracle to TiDB - The AWS DMS is used for the data migration. Will not explain this part in this article.
It's a really challenge if the number of tables exceed 500 within one day manually. In order to complete this task on time, I was looking for proper tools to do that. [Transferdb](https://github.com/wentaojin/transferdb) is the one I recommend to you for DDL conversion from oracle to mysql protocol database. I will prepare another article to introduce how to use. As a result, it took me only 30 minutes to the DDL conversion automatically.
The another task is test data generation for these 500 tables. This mockdata helps you to achieve it winthin another 30 minutes. The idea behind is simple. It reads the metadata from oracle and generate test data according to the data type(varchar2, char, number, timestamp and date) and foreign key to insert. If foreign key exists in the table, the depended tables' data is generated first and pick up the data into the child tables' foreign key's column.
In the next section, I will introduce how to use mockdata to generate test data.
# Installation and usage
## Download the binary to linux
```
admin@workstation:/tmp/mockdata$ wget https://github.com/luyomo/mockdata/releases/download/v0.0.5/mockoracle-0.0.5.x86_64-linux.tar.gz
admin@workstation:/tmp/mockdata$ tar xvf mockoracle-0.0.5.x86_64-linux.tar.gz
```

## Oracle lib preparation
```
admin@workstation/tmp/mockdata$ wget https://download.oracle.com/otn_software/linux/instantclient/214000/instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
admin@workstation/tmp/mockdata$ sudo unzip -d /opt/oracle instantclient-basic-linux.x64-21.4.0.0.0dbru.zip
admin@workstation/tmp/mockdata$ export LD_LIBRARY_PATH=/opt/oracle/instantclient_21_4:$LD_LIBRARY_PATH
```

## Config file preparation
```
admin@workstation:/tmp/mockdata$ more /tmp/mockdata/config.toml
[oracle]
username = "user"
password = "password"
host = "oracle host name"
port = 1521
service-name = "dev"
```

## Data generation from mockoracle
### Single table data generation
Insert 20 rows to table admin.table01 and admin.table02.
```
admin@workstation:/tmp/mockdata$ ./bin/mockoracle --config=/tmp/mockdata/config.toml --tables=admin.table01,admin.table02 --num-of-rows=20
20 rows have been instered into table(admin.table01)
20 rows have been instered into table(admin.table02)
```
### Table data generation with foreign key
Here is the example that the table(table01) depends on table(table02), which depends on table(table03). The data is generated by the sequence as follow: table03 -> table02 -> table01. Please find the below example.
If there is data in the parent table, it skip data insertion into parent table. The child table take parent table's data by random.
```
admin@workstation:/tmp/mockdata$ ./bin/mockoracle --config=/tmp/mockdata/config.toml --tables=admin.table01 --num-of-rows=20
Starting to generate data for ADMIN.TEST01 ... ...  
Table(ADMIN.TABLE03) depended by table(ADMIN.TABLE02) has data(25 rows). Skip data generation
Table(ADMIN.TABLE02) depended by table(ADMIN.TABLE01) has data(25 rows). Skip data generation
20 rows have been instered into table(ADMIN.TABLE01) 
```

### Table data generation for one schema without prompt
```
admin@workstation:/tmp/mockdata$ ./bin/mockoracle --config=/tmp/mockdata/config.toml --tables=ADMIN.* --num-of-rows=5 --prompt=false
Starting to generate data for ADMIN.TEST01 ... ...       
Table(ADMIN.TEST02) depended by table(ADMIN.TEST01) has data(45 rows). Skip data generation 
Error inserting: <&godror.OraErr{message:"unique constraint (ADMIN.TEST01) violated", funName:"dpiStmt_execute", action:"execute", sqlState:"HY000", code:1, offset:0, reco
verable:false, warning:false}>                                                            
4 rows have been instered into table(ADMIN.TEST01)  

Starting to generate data for ADMIN.TEST03 ... ... 
5 rows have been instered into table(ADMIN.TEST03)

... ...

```

### Table data generation for one schema with prompt
```
./bin/mockoracle --config=/tmp/mockdata/config.toml --tables=ADMIN.* --num-of-rows=5
Do you want to generate the data for ADMIN.TEST01?(default=Y) N
Skip the data generation ... ...  
Do you want to generate the data for ADMIN.TEST02?(default=Y) Y
Starting to generate data for ADMIN.TEST01 ... ... 
5 rows have been instered into table(ADMIN.TEST01) 
```

# Others
* Tool does not support primary key's uniqueness. The data is generated randomly, if it fails, please re-run it. That's the reason there are key conflict errors.
* The timestamp is not garanteed. Currently it only supports 23-JAN-23 10:11:23.000000 PM

# Demo
(Data generation demo)[https://www.youtube.com/watch?v=QtOXr-EJAps]

# TODO
## Check table whether has foreign key
Add reference key into config
  table name |
```
SELECT a.table_name, a.column_name, a.constraint_name, c.owner,
       c.r_owner, c_pk.table_name r_table_name, c_pk.constraint_name r_pk
  FROM all_cons_columns a
  JOIN all_constraints c
    ON a.owner = c.owner
   AND a.constraint_name = c.constraint_name
  JOIN all_constraints c_pk
    ON c.r_owner = c_pk.owner
   AND c.r_constraint_name = c_pk.constraint_name
 WHERE c.constraint_type = 'R'
   AND a.owner = 'ADMIN'
   AND a.table_name = 'ADMIN_USER'
```

## Query to get columns
```
SELECT tbl.OWNER as SCHEMA_NAME, tbl.TABLE_NAME, tbl.COLUMN_NAME,  ref_tbl.REF_QUERY
     , DATA_TYPE, DATA_LENGTH, DATA_PRECISION, DATA_SCALE, NULLABLE, CHARACTER_SET_NAME
     , COLLATION, USER_GENERATED, ref_tbl.REF_QUERY
FROM  DBA_TAB_COLS tbl
LEFT JOIN (
 SELECT c.owner, a.table_name, a.column_name,
        'SELECT ' || c_cols.column_name || ' FROM ' || c.r_owner || '.' ||  c_pk.table_name as ref_query
   FROM all_cons_columns a
   JOIN all_constraints c
     ON a.owner = c.owner
    AND a.constraint_name = c.constraint_name
   JOIN all_constraints c_pk
     ON c.r_owner = c_pk.owner
    AND c.r_constraint_name = c_pk.constraint_name
   JOIN all_cons_columns c_cols
     ON c_pk.owner = c_cols.owner
    AND c_pk.constraint_name = c_cols.constraint_name
  WHERE c.constraint_type = 'R'
    AND UPPER(a.owner) = UPPER('ADMIN')
    AND UPPER(a.table_name) = UPPER('ADMIN_USER')
  ) ref_tbl
  ON tbl.owner = ref_tbl.owner
 AND tbl.table_name = ref_tbl.table_name
 AND tbl.column_name = ref_tbl.column_name
WHERE UPPER(tbl.owner) = UPPER('ADMIN')
AND UPPER(tbl.TABLE_NAME) = UPPER('ADMIN_USER')
ORDER BY COLUMN_ID



        c.r_owner, c_pk.table_name r_table_name, c_cols.column_name r_column_name,

 SELECT c.owner, a.table_name, c.constraint_name, c_cols.owner as r_owner, c_cols.table_name as r_table_name, c_cols.column_name || ' AS ' || a.column_name as r_column_name
   FROM all_cons_columns a
   JOIN all_constraints c
     ON a.owner = c.owner
    AND a.constraint_name = c.constraint_name
   JOIN all_constraints c_pk
     ON c.r_owner = c_pk.owner
    AND c.r_constraint_name = c_pk.constraint_name
   JOIN all_cons_columns c_cols
     ON c_pk.owner = c_cols.owner
    AND c_pk.constraint_name = c_cols.constraint_name
    AND a.POSITION = c_cols.POSITION
  WHERE c.constraint_type = 'R'
    AND a.owner = 'ADMIN'
    AND a.table_name = 'CARD_USER_OPTION'
  order by CONSTRAINT_NAME

  SELECT *
    FROM all_constraints c
    JOIN all_constraints c_pk
      ON c.r_owner = c_pk.owner
     AND c.r_constraint_name = c_pk.constraint_name

```

```
SELECT tbl.OWNER as SCHEMA_NAME, tbl.TABLE_NAME, tbl.COLUMN_NAME,  ref_tbl.REF_QUERY
       , DATA_TYPE, DATA_LENGTH, DATA_PRECISION, DATA_SCALE, NULLABLE, CHARACTER_SET_NAME
       , COLLATION, USER_GENERATED
  FROM  DBA_TAB_COLS tbl
  LEFT JOIN (
   SELECT c.owner, a.table_name, a.column_name
        , 'SELECT ' || c_cols.column_name || ' FROM ' || c.r_owner || '.' ||  c_pk.table_name || ' where rownum < 3' as ref_query
     FROM all_cons_columns a
     JOIN all_constraints c
       ON a.owner = c.owner
      AND a.constraint_name = c.constraint_name
     JOIN all_constraints c_pk
       ON c.r_owner = c_pk.owner
      AND c.r_constraint_name = c_pk.constraint_name
     JOIN all_cons_columns c_cols
       ON c_pk.owner = c_cols.owner
      AND c_pk.constraint_name = c_cols.constraint_name
      AND a.POSITION = c_cols.POSITION
    WHERE c.constraint_type = 'R'
      AND UPPER(a.owner) = UPPER('GIFTBT')
      AND UPPER(a.table_name) = UPPER('REPORT_DDMM')
    ) ref_tbl
    ON tbl.owner = ref_tbl.owner
   AND tbl.table_name = ref_tbl.table_name
   AND tbl.column_name = ref_tbl.column_name
   AND tbl.HIDDEN_COLUMN = 'NO'
  WHERE UPPER(tbl.owner) = UPPER('GIFTBT')
  AND UPPER(tbl.TABLE_NAME) = UPPER('REPORT_DDMM')
  ORDER BY COLUMN_ID
```
